<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Review Forecasts</title>
    <link rel="stylesheet" href="../styles.css">
    <link rel="stylesheet" href="admin-styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        .my-table th.actions-col, .my-table td.actions-col {
            min-width: 140px;
            width: 140px;
            text-align: left;
        }
        .action-btn {
            display: inline-block;
            margin: 0 2px 0 0;
            vertical-align: middle;
            min-width: 48px;
            padding: 4px 10px;
            font-size: 0.98em;
            border-radius: 5px;
        }
        .view-btn.action-btn, .edit-btn.action-btn {
            width: auto;
            min-width: 48px;
            padding: 4px 10px;
            font-size: 0.98em;
        }
        .forward-btn.action-btn {
            width: auto;
            min-width: 36px;
            padding: 4px 6px;
            font-size: 0.98em;
        }
        /* Style for edit modal input fields */
        #modal-questionnaire-content input[type="text"] {
            border: 1px solid #bfc9d9;
            border-radius: 5px;
            padding: 7px 12px;
            font-size: 1em;
            background: #f7faff;
            margin: 2px 0;
            transition: border 0.2s, box-shadow 0.2s;
            box-sizing: border-box;
        }
        #modal-questionnaire-content input[type="text"]:focus {
            border: 1.5px solid #2563eb;
            outline: none;
            background: #fff;
            box-shadow: 0 0 0 2px #2563eb22;
        }
        .context-section {
  display: flex;
  gap: 18px;
  align-items: center;
  margin-bottom: 18px;
}
.context-section label {
  min-width: 60px;
  margin-bottom: 0;
}
.context-section input[type="date"],
.context-section select {
  min-width: 180px;
  max-width: 220px;
  padding: 8px 10px;
  border-radius: 6px;
  border: 1.5px solid #e57373;
  font-size: 1em;
}
    </style>
</head>
<body>
    <div class="sidebar">
        <img src="../loggg.jpeg" alt="Logo" class="home-logo" style="display:block;margin:0 auto 16px auto;max-width:120px;">
        <h2>Admin Dashboard</h2>
        <nav class="sidebar-nav">
            <a href="index.html" class="nav-link">
                <span class="nav-icon">üìä</span>
                Dashboard
            </a>
            <a href="review-forecasts.html" class="nav-link active">
                <span class="nav-icon">üìã</span>
                Review Forecasts
            </a>
            <a href="review-activities.html" class="nav-link">
                <span class="nav-icon">üìù</span>
                Review Activities
            </a>
            <a href="settings.html" class="nav-link">
                <span class="nav-icon">‚öôÔ∏è</span>
                Settings
            </a>
            <a href="submission-history.html" class="nav-link">
                <span class="nav-icon">üïì</span>
                Submission History
            </a>
        </nav>
        <button id="logoutBtn" class="logout-btn" style="margin: 24px 0 0 0; width: 90%; display: block; background: #e53935; color: #fff; font-weight: bold; border: none; border-radius: 6px; padding: 12px 0; cursor: pointer;">Log Out</button>
    </div>

    <div class="content">
        <div class="page">
            <div class="page-header">
                <h1 class="page-title">
                    <span class="title-icon">üìã</span>
                    Review Weekly Forecasts
                </h1>
            </div>
            <div id="forward-success-message" style="display:none;color:#388e3c;background:#e8f5e9;padding:10px 18px;border-radius:6px;margin-bottom:18px;font-weight:600;text-align:center;"></div>
            
            <!-- Add assignment info card at the top -->
            <div class="assignment-info" style="background: #f8fafc; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.04); padding: 20px 32px; margin-bottom: 24px; display: flex; gap: 40px; align-items: flex-end; max-width: 700px;">
                <div style="display: flex; flex-direction: column; min-width: 180px;">
                    <label style="font-weight: 600; color: #2563eb; font-size: 1.08em; margin-bottom: 4px;">Region</label>
                    <input type="text" id="region-display" readonly style="background:#f3f3f3; border: 1px solid #d1d5db; border-radius: 6px; min-width: 160px; font-size: 1.08em; padding: 7px 10px; color: #222; font-weight: 500;" />
                </div>
                <div style="display: flex; flex-direction: column; min-width: 180px;">
                    <label style="font-weight: 600; color: #2563eb; font-size: 1.08em; margin-bottom: 4px;">Date of Forwarding</label>
                    <input type="date" id="forward-date" style="background:#f3f3f3; border: 1px solid #d1d5db; border-radius: 6px; min-width: 160px; font-size: 1.08em; padding: 7px 10px; color: #222; font-weight: 500;" />
                </div>
            </div>
            <script>
            document.addEventListener('DOMContentLoaded', async function() {
                const user = JSON.parse(localStorage.getItem('user'));
                const regions = await fetch('http://localhost:3000/api/regions').then(r => r.json());
                function findName(arr, id) {
                    if (!id) return '';
                    const item = arr.find(x => String(x.id) === String(id));
                    if (!item) return '(Unassigned)';
                    return item.name;
                }
                document.getElementById('region-display').value = findName(regions, user && user.region_id);
            });
            </script>
            
            <!-- Forecasts Table -->
            <div class="card table-card">
                <div class="table-container">
                    <div style="display: flex; justify-content: center; align-items: center; margin-bottom: 16px;">
                        <input id="search-bar" type="text" placeholder="Search reports..." style="width: 340px; padding: 8px 14px; border-radius: 6px; border: 1.5px solid #e57373; font-size: 1em;" />
                    </div>
                    <div style="display: flex; justify-content: flex-end; align-items: center; margin-bottom: 12px;">
                        <button id="send-selected-btn" class="submit-btn" style="margin-right: 12px;">Send Selected</button>
                        <button id="filter-toggle-btn" class="submit-btn" style="padding: 8px 22px;">Filter</button>
                    </div>
                    <div id="filter-panel" class="filter-panel" style="display:none; position:absolute; right:32px; top:80px; background:#fff; border:1.5px solid #e57373; border-radius:8px; box-shadow:0 4px 24px #0001; padding:18px 22px; z-index:1002; min-width:320px;">
                        <button id="close-filter-btn" style="position:absolute;top:8px;right:12px;font-size:1.3em;background:none;border:none;color:#b71c1c;cursor:pointer;">&times;</button>
                        <div style="display:flex; flex-direction:column; gap:12px;">
                            <label>Status
                                <select id="filter-status">
                                    <option value="">All</option>
                                    <option value="READ">READ</option>
                                    <option value="UNREAD">UNREAD</option>
                                </select>
                            </label>
                            <label>Date Range
                                <input type="date" id="filter-date-start" style="margin-right:8px;" />
                                <input type="date" id="filter-date-end" />
                            </label>
                            <label>Region
                                <select id="filter-region"><option value="">All</option></select>
                            </label>
                            <label>Zone
                                <select id="filter-zone"><option value="">All</option></select>
                            </label>
                            <label>Circuit
                                <select id="filter-circuit"><option value="">All</option></select>
                            </label>
                            <button id="apply-filter-btn" class="submit-btn" style="margin-top:8px;">Apply</button>
                        </div>
                    </div>
                    <style>
                    .filter-panel label { font-weight: 500; color: #b71c1c; }
                    .filter-panel select, .filter-panel input[type="date"] { width: 100%; margin-top: 2px; margin-bottom: 6px; }
                    </style>
                    <table class="my-table">
                        <thead>
                            <tr>
                                <th><input type="checkbox" id="select-all-checkbox"></th>
                                <th>Date</th>
                                <th>Zone</th>
                                <th>Status</th>
                                <th class="actions-col">Action</th>
                            </tr>
                        </thead>
                        <tbody id="forecasts-table-body">
                            <!-- Will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Review Modal -->
    <div id="review-modal" class="modal">
        <div class="modal-content">
            <button class="close-btn" onclick="closeModal()" style="position:absolute;top:10px;right:16px;font-size:1.5em;background:none;border:none;color:#888;cursor:pointer;">&times;</button>
            <h2 style="margin-top:0;">Review Forecast</h2>
            <div id="modal-questionnaire-content"></div>
        </div>
    </div>
    <!-- Profile Icon Button -->
    <button class="profile-icon-btn" id="profileIconBtn" title="Profile" style="position:fixed;top:18px;right:24px;z-index:100;">
      <svg viewBox="0 0 64 64" fill="none"><circle cx="32" cy="32" r="32" fill="#e3eaff"/><path d="M32 34c6.627 0 12-5.373 12-12S38.627 10 32 10 20 15.373 20 22s5.373 12 12 12zm0 4c-8.837 0-16 7.163-16 16v2h32v-2c0-8.837-7.163-16-16-16z" fill="#2563eb"/></svg>
    </button>
    <!-- Profile Modal Backdrop and Modal -->
    <div class="profile-modal-backdrop" id="profileModalBackdrop"></div>
    <div class="profile-modal" id="profileModal" style="display:none;">
      <button class="close-profile-modal" id="closeProfileModal">&times;</button>
      <div class="profile-avatar">
        <svg viewBox="0 0 64 64" fill="none"><circle cx="32" cy="32" r="32" fill="#e3eaff"/><path d="M32 34c6.627 0 12-5.373 12-12S38.627 10 32 10 20 15.373 20 22s5.373 12 12 12zm0 4c-8.837 0-16 7.163-16 16v2h32v-2c0-8.837-7.163-16-16-16z" fill="#fff"/></svg>
      </div>
      <div class="profile-username" id="profileUsername" style="text-align:center;font-weight:600;font-size:1.1em;margin-top:8px;"></div>
      <div class="profile-assignment" id="profileAssignment" style="text-align:center;font-size:0.98em;color:#2563eb;margin-bottom:8px;"></div>
      <div class="profile-btn-row">
        <button id="editProfileBtn">EDIT</button>
        <button id="changePassBtn">PASS</button>
      </div>
      <button class="logout-btn" id="logoutBtn">LOG OUT</button>
    </div>
    <!-- Profile Edit Modal -->
    <div class="profile-edit-modal-backdrop" id="profileEditModalBackdrop"></div>
    <div class="profile-edit-modal" id="profileEditModal" style="display:none;">
      <button class="close-edit-modal" id="closeEditModal">&times;</button>
      <h2>Edit Profile</h2>
      <form id="profileEditForm">
        <div class="form-group"><label for="editDob">Date of Birth</label><input type="date" id="editDob" name="dob"></div>
        <div class="form-group"><label for="editPhone">Phone Number</label><input type="text" id="editPhone" name="phone_number"></div>
        <div class="form-group"><label for="editSex">Sex</label><select id="editSex" name="sex"><option value="">Select</option><option value="Male">Male</option><option value="Female">Female</option><option value="Other">Other</option></select></div>
        <div class="form-group"><label for="editAims">AIMS Number</label><input type="text" id="editAims" name="aims_number"></div>
        <button type="submit" class="submit-btn">Save</button>
      </form>
    </div>
    <script>
    async function fetchForecasts() {
        const user = JSON.parse(localStorage.getItem('user'));
        let url = `http://localhost:3000/api/questionnaire-responses?type=forecast&stage=regional`;
        if (user && user.region_id) url += `&region_id=${user.region_id}`;
        const res = await fetch(url);
        return await res.json();
    }
    function extractForecastFields(response) {
        let answers = response.answers;
        if (typeof answers === 'string') {
            try { answers = JSON.parse(answers); } catch (e) { answers = {}; }
        }
        let tajneedTotal = '', motamadAttendance = '', motamadMeetings = '';
        if (answers['Mohtamim Tajneed'] && answers['Mohtamim Tajneed']['Tajneed']) {
            tajneedTotal = answers['Mohtamim Tajneed']['Tajneed']['Total'] || '';
        }
        if (answers['Motamad']) {
            motamadAttendance = answers['Motamad']['Attendance'] || '';
            motamadMeetings = answers['Motamad']['No. of National Amila Meetings held this month'] || '';
        }
        return {
            week_number: motamadMeetings,
            subject: motamadAttendance,
            topic: tajneedTotal
        };
    }
    function renderQuestionnaireModal(answers) {
        const container = document.getElementById('modal-questionnaire-content');
        container.innerHTML = '';
        Object.entries(answers).forEach(([topic, questions]) => {
            const topicDiv = document.createElement('div');
            topicDiv.className = 'modal-topic';
            const topicTitle = document.createElement('h4');
            topicTitle.style.color = '#2563eb';
            topicTitle.style.fontSize = '1.15em';
            topicTitle.style.marginTop = '18px';
            topicTitle.textContent = topic;
            topicDiv.appendChild(topicTitle);
            // Create a table for questions/answers
            const table = document.createElement('table');
            table.style.width = '100%';
            table.style.borderCollapse = 'collapse';
            table.style.marginBottom = '18px';
            const thead = document.createElement('thead');
            const headerRow = document.createElement('tr');
            const qth = document.createElement('th');
            qth.textContent = 'Question';
            qth.style.background = 'linear-gradient(90deg, #e3eaff, #f3f6fa)';
            qth.style.color = '#1741a6';
            qth.style.padding = '6px 10px';
            qth.style.textAlign = 'left';
            const ath = document.createElement('th');
            ath.textContent = 'Answer';
            ath.style.background = 'linear-gradient(90deg, #e3eaff, #f3f6fa)';
            ath.style.color = '#1741a6';
            ath.style.padding = '6px 10px';
            ath.style.textAlign = 'left';
            headerRow.appendChild(qth);
            headerRow.appendChild(ath);
            thead.appendChild(headerRow);
            table.appendChild(thead);
            const tbody = document.createElement('tbody');
            let rowIdx = 0;
            Object.entries(questions).forEach(([label, value]) => {
                if (typeof value === 'object' && value !== null && !Array.isArray(value)) {
                    Object.entries(value).forEach(([subLabel, subValue]) => {
                        const row = document.createElement('tr');
                        row.style.background = rowIdx % 2 === 0 ? '#f7faff' : '#fff';
                        const qCell = document.createElement('td');
                        qCell.textContent = label + ' - ' + subLabel;
                        qCell.style.fontWeight = 'bold';
                        qCell.style.padding = '6px 10px';
                        const aCell = document.createElement('td');
                        aCell.textContent = subValue;
                        aCell.style.padding = '6px 10px';
                        row.appendChild(qCell);
                        row.appendChild(aCell);
                        tbody.appendChild(row);
                        rowIdx++;
                    });
                } else {
                    const row = document.createElement('tr');
                    row.style.background = rowIdx % 2 === 0 ? '#f7faff' : '#fff';
                    const qCell = document.createElement('td');
                    qCell.textContent = label;
                    qCell.style.fontWeight = 'bold';
                    qCell.style.padding = '6px 10px';
                    const aCell = document.createElement('td');
                    aCell.textContent = value;
                    aCell.style.padding = '6px 10px';
                    row.appendChild(qCell);
                    row.appendChild(aCell);
                    tbody.appendChild(row);
                    rowIdx++;
                }
            });
            table.appendChild(tbody);
            topicDiv.appendChild(table);
            container.appendChild(topicDiv);
        });
    }
    function openModal(answers) {
        let parsedAnswers = answers;
        if (typeof answers === 'string') {
            try {
                parsedAnswers = JSON.parse(answers);
            } catch (e) {
                parsedAnswers = {};
            }
        }
        renderQuestionnaireModal(parsedAnswers);
        document.getElementById('review-modal').style.display = 'block';
    }
    function closeModal() {
        document.getElementById('review-modal').style.display = 'none';
    }
    async function loadForecasts() {
        const forecasts = await fetchForecasts();
        // Sort by submitted_at (or id) descending so newest is first
        forecasts.sort((a, b) => {
            const dateA = a.submitted_at ? new Date(a.submitted_at) : new Date(0);
            const dateB = b.submitted_at ? new Date(b.submitted_at) : new Date(0);
            if (dateA.getTime() !== dateB.getTime()) {
                return dateB - dateA; // Most recent first
            }
            return (b.id || 0) - (a.id || 0); // Fallback to id
        });
        const tbody = document.getElementById('forecasts-table-body');
        tbody.innerHTML = '';
        forecasts.forEach(forecast => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td><input type="checkbox" class="row-checkbox" data-id="${forecast.id}"></td>
                <td>${forecast.submitted_at ? new Date(forecast.submitted_at).toLocaleDateString() : ''}</td>
                <td>${forecast.zone_name || ''}</td>
                <td class="status-cell">${forecast.status === 'READ' ? 'READ' : 'UNREAD'}</td>
                <td class="actions-col"></td>
            `;
            const actionCell = tr.querySelector('td.actions-col');
            // Create and append only one set of buttons
            const viewBtn = document.createElement('button');
            viewBtn.className = 'view-btn action-btn';
            viewBtn.textContent = 'View';
            viewBtn.onclick = () => openModal(forecast.answers);
            const editBtn = document.createElement('button');
            editBtn.className = 'edit-btn action-btn';
            editBtn.style.background = '#f59e42';
            editBtn.textContent = 'Edit';
            editBtn.onclick = () => openEditModal(forecast.answers, forecast.id);
            const forwardBtn = document.createElement('button');
            forwardBtn.className = 'forward-btn action-btn';
            forwardBtn.style.background = '#4caf50';
            forwardBtn.textContent = 'SEND';
            forwardBtn.onclick = async () => {
                const forwardDate = document.getElementById('forward-date').value;
                if (!forwardDate) {
                    alert('Please select the Date of Forwarding before sending reports.');
                    return;
                }
                const user = JSON.parse(localStorage.getItem('user'));
                const submitted_by = user ? user.id : null;
                await fetch('http://localhost:3000/api/questionnaire-responses', {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id: forecast.id, stage: 'national', submitted_by, regional_forward_date: forwardDate })
                });
                alert('Forwarded forecast with ID: ' + forecast.id + ' to National Level.');
                loadForecasts();
                document.getElementById('forward-success-message').textContent = 'Report forwarded successfully!';
                document.getElementById('forward-success-message').style.display = 'block';
                setTimeout(() => { document.getElementById('forward-success-message').style.display = 'none'; }, 2500);
            };
            const checkBtn = document.createElement('button');
            checkBtn.className = 'check-btn action-btn';
            checkBtn.style.background = '#2196f3';
            checkBtn.style.fontWeight = 'bold';
            checkBtn.title = 'Toggle Read/Unread';
            checkBtn.textContent = forecast.status === 'READ' ? 'UNREAD' : 'READ';
            checkBtn.onclick = () => {
                // Toggle status visually
                const statusCell = tr.querySelector('.status-cell');
                if (checkBtn.textContent === 'READ') {
                    checkBtn.textContent = 'UNREAD';
                    statusCell.textContent = 'READ';
                } else {
                    checkBtn.textContent = 'READ';
                    statusCell.textContent = 'UNREAD';
                }
                // Optionally, send update to backend here
            };
            actionCell.appendChild(viewBtn);
            actionCell.appendChild(editBtn);
            actionCell.appendChild(forwardBtn);
            actionCell.appendChild(checkBtn);
            tbody.appendChild(tr);
        });

        // Forward function placeholder
        window.forwardForecast = async function(id) {
            // Update stage to 'national' for this report
            const user = JSON.parse(localStorage.getItem('user'));
            const submitted_by = user ? user.id : null;
            const forwardDate = document.getElementById('forward-date').value;
            if (!forwardDate) {
                alert('Please select the Date of Forwarding before sending reports.');
                return;
            }
            await fetch('http://localhost:3000/api/questionnaire-responses', {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ id, stage: 'national', submitted_by, regional_forward_date: forwardDate })
            });
            alert('Forwarded forecast with ID: ' + id + ' to National Level.');
            loadForecasts();
            document.getElementById('forward-success-message').textContent = 'Report forwarded successfully!';
            document.getElementById('forward-success-message').style.display = 'block';
            setTimeout(() => { document.getElementById('forward-success-message').style.display = 'none'; }, 2500);
        };

        // Select all logic
        const selectAll = document.getElementById('select-all-checkbox');
        selectAll.onclick = function() {
            document.querySelectorAll('.row-checkbox').forEach(cb => {
                cb.checked = selectAll.checked;
            });
        };
        // Uncheck select-all if any row is unchecked
        tbody.querySelectorAll('.row-checkbox').forEach(cb => {
            cb.addEventListener('change', function() {
                if (!this.checked) selectAll.checked = false;
                else if ([...tbody.querySelectorAll('.row-checkbox')].every(c => c.checked)) selectAll.checked = true;
            });
        });
        // SEND SELECTED button logic
        document.getElementById('send-selected-btn').onclick = function() {
            const selectedIds = [...document.querySelectorAll('.row-checkbox:checked')].map(cb => cb.dataset.id);
            if (selectedIds.length === 0) {
                alert('No reports selected.');
                return;
            }
            forwardSelectedReports(selectedIds);
        };
        // Placeholder for forwarding selected
        window.forwardSelectedReports = async function(ids) {
            const forwardDate = document.getElementById('forward-date').value;
            if (!forwardDate) {
                alert('Please select the Date of Forwarding before sending reports.');
                return;
            }
            const user = JSON.parse(localStorage.getItem('user'));
            const submitted_by = user ? user.id : null;
            for (const id of ids) {
                await fetch('http://localhost:3000/api/questionnaire-responses', {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id, stage: 'national', submitted_by, regional_forward_date: forwardDate })
                });
            }
            alert('Forwarded selected reports to National Level.');
            loadForecasts();
            document.getElementById('forward-success-message').textContent = 'Reports forwarded successfully!';
            document.getElementById('forward-success-message').style.display = 'block';
            setTimeout(() => { document.getElementById('forward-success-message').style.display = 'none'; }, 2500);
        };
    }

    // Editable modal logic
    function renderEditableQuestionnaireModal(answers) {
        const container = document.getElementById('modal-questionnaire-content');
        container.innerHTML = '';
        Object.entries(answers).forEach(([topic, questions]) => {
            const topicDiv = document.createElement('div');
            topicDiv.className = 'modal-topic';
            const topicTitle = document.createElement('h4');
            topicTitle.style.color = '#2563eb';
            topicTitle.style.fontSize = '1.15em';
            topicTitle.style.marginTop = '18px';
            topicTitle.textContent = topic;
            topicDiv.appendChild(topicTitle);
            const table = document.createElement('table');
            table.style.width = '100%';
            table.style.borderCollapse = 'collapse';
            table.style.marginBottom = '18px';
            const thead = document.createElement('thead');
            const headerRow = document.createElement('tr');
            const qth = document.createElement('th');
            qth.textContent = 'Question';
            qth.style.background = 'linear-gradient(90deg, #e3eaff, #f3f6fa)';
            qth.style.color = '#1741a6';
            qth.style.padding = '6px 10px';
            qth.style.textAlign = 'left';
            const ath = document.createElement('th');
            ath.textContent = 'Answer';
            ath.style.background = 'linear-gradient(90deg, #e3eaff, #f3f6fa)';
            ath.style.color = '#1741a6';
            ath.style.padding = '6px 10px';
            ath.style.textAlign = 'left';
            headerRow.appendChild(qth);
            headerRow.appendChild(ath);
            thead.appendChild(headerRow);
            table.appendChild(thead);
            const tbody = document.createElement('tbody');
            let rowIdx = 0;
            Object.entries(questions).forEach(([label, value]) => {
                if (typeof value === 'object' && value !== null && !Array.isArray(value)) {
                    Object.entries(value).forEach(([subLabel, subValue]) => {
                        const row = document.createElement('tr');
                        row.style.background = rowIdx % 2 === 0 ? '#f7faff' : '#fff';
                        const qCell = document.createElement('td');
                        qCell.textContent = label + ' - ' + subLabel;
                        qCell.style.fontWeight = 'bold';
                        qCell.style.padding = '6px 10px';
                        const aCell = document.createElement('td');
                        const input = document.createElement('input');
                        input.type = 'text';
                        input.value = subValue;
                        input.style.width = '100%';
                        input.style.padding = '4px 8px';
                        input.dataset.topic = topic;
                        input.dataset.label = label;
                        input.dataset.sublabel = subLabel;
                        aCell.appendChild(input);
                        aCell.style.padding = '6px 10px';
                        row.appendChild(qCell);
                        row.appendChild(aCell);
                        tbody.appendChild(row);
                        rowIdx++;
                    });
                } else {
                    const row = document.createElement('tr');
                    row.style.background = rowIdx % 2 === 0 ? '#f7faff' : '#fff';
                    const qCell = document.createElement('td');
                    qCell.textContent = label;
                    qCell.style.fontWeight = 'bold';
                    qCell.style.padding = '6px 10px';
                    const aCell = document.createElement('td');
                    const input = document.createElement('input');
                    input.type = 'text';
                    input.value = value;
                    input.style.width = '100%';
                    input.style.padding = '4px 8px';
                    input.dataset.topic = topic;
                    input.dataset.label = label;
                    aCell.appendChild(input);
                    aCell.style.padding = '6px 10px';
                    row.appendChild(qCell);
                    row.appendChild(aCell);
                    tbody.appendChild(row);
                    rowIdx++;
                }
            });
            table.appendChild(tbody);
            topicDiv.appendChild(table);
            container.appendChild(topicDiv);
        });
    }
    function openEditModal(answers, id) {
        let parsedAnswers = answers;
        if (typeof answers === 'string') {
            try {
                parsedAnswers = JSON.parse(answers);
            } catch (e) {
                parsedAnswers = {};
            }
        }
        renderEditableQuestionnaireModal(parsedAnswers);
        document.getElementById('review-modal').style.display = 'block';
        // Add Save button
        let modalContent = document.querySelector('#review-modal .modal-content');
        let saveBtn = document.getElementById('edit-save-btn');
        if (!saveBtn) {
            saveBtn = document.createElement('button');
            saveBtn.id = 'edit-save-btn';
            saveBtn.className = 'submit-btn';
            saveBtn.textContent = 'Save';
            saveBtn.style.marginTop = '18px';
            saveBtn.onclick = () => saveEditedAnswers(id);
            modalContent.appendChild(saveBtn);
        }
    }
    async function saveEditedAnswers(id) {
        // Collect all input values
        const inputs = document.querySelectorAll('#modal-questionnaire-content input');
        const updatedAnswers = {};
        inputs.forEach(input => {
            const topic = input.dataset.topic;
            const label = input.dataset.label;
            const sublabel = input.dataset.sublabel;
            if (!updatedAnswers[topic]) updatedAnswers[topic] = {};
            if (sublabel) {
                if (!updatedAnswers[topic][label]) updatedAnswers[topic][label] = {};
                updatedAnswers[topic][label][sublabel] = input.value;
            } else {
                updatedAnswers[topic][label] = input.value;
            }
        });
        // Send update to backend
        try {
            const res = await fetch(`http://localhost:3000/api/questionnaire-responses`, {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ id, answers: updatedAnswers })
            });
            if (!res.ok) throw new Error('Failed to save changes');
            alert('Answers updated successfully!');
            closeModal();
            loadForecasts();
        } catch (err) {
            alert('Failed to save changes.');
        }
    }
    // Get user from localStorage
    const user = JSON.parse(localStorage.getItem('user') || '{}');
    let regions = [];
    async function fetchRegions() {
        const r = await fetch('http://localhost:3000/api/regions').then(r => r.json());
        regions = r;
        populateRegionDropdown();
    }
    function populateRegionDropdown() {
        const regionSelect = document.getElementById('region-context');
        regionSelect.innerHTML = '<option value="">Select Region</option>' +
            regions.map(r => `<option value="${r.id}">${r.name}</option>`).join('');
    }
    fetchRegions();
    // TODO: Update filtering logic to use date and region
    // Fetch zones and circuits for this regional's region
    async function populateCircuitFilter() {
        const zonesRes = await fetch('http://localhost:3000/api/zones');
        const zones = await zonesRes.json();
        const circuitsRes = await fetch('http://localhost:3000/api/circuits');
        const circuits = await circuitsRes.json();
        const zoneIds = zones.filter(z => z.region_id == user.region_id).map(z => z.id);
        const circuitFilter = document.getElementById('circuit-filter');
        circuitFilter.innerHTML = '<option value="">All Circuits</option>' +
            circuits.filter(c => zoneIds.includes(c.zone_id)).map(c => `<option value="${c.id}">${c.name}</option>`).join('');
    }
    document.addEventListener('DOMContentLoaded', loadForecasts);
    document.getElementById('filter-toggle-btn').onclick = function() {
        const panel = document.getElementById('filter-panel');
        panel.style.display = (panel.style.display === 'none' || !panel.style.display) ? 'block' : 'none';
    };
    document.getElementById('close-filter-btn').onclick = function() {
        document.getElementById('filter-panel').style.display = 'none';
    };
    document.getElementById('apply-filter-btn').onclick = function() {
        const status = document.getElementById('filter-status').value;
        const dateStart = document.getElementById('filter-date-start').value;
        const dateEnd = document.getElementById('filter-date-end').value;
        const region = document.getElementById('filter-region').value;
        const zone = document.getElementById('filter-zone').value;
        const circuit = document.getElementById('filter-circuit').value;
        // Filter table rows based on selected filters
        const rows = document.querySelectorAll('.my-table tbody tr');
        rows.forEach(row => {
            let show = true;
            if (status) {
                const statusCell = row.querySelector('.status-cell');
                if (statusCell && statusCell.textContent.trim() !== status) show = false;
            }
            if (dateStart) {
                const dateCell = row.children[1];
                if (dateCell && new Date(dateCell.textContent) < new Date(dateStart)) show = false;
            }
            if (dateEnd) {
                const dateCell = row.children[1];
                if (dateCell && new Date(dateCell.textContent) > new Date(dateEnd)) show = false;
            }
            if (region) {
                const regionCell = row.getAttribute('data-region-id');
                if (regionCell && regionCell !== region) show = false;
            }
            if (zone) {
                const zoneCell = row.getAttribute('data-zone-id');
                if (zoneCell && zoneCell !== zone) show = false;
            }
            if (circuit) {
                const circuitCell = row.getAttribute('data-circuit-id');
                if (circuitCell && circuitCell !== circuit) show = false;
            }
            row.style.display = show ? '' : 'none';
        });
        document.getElementById('filter-panel').style.display = 'none';
    };
    document.getElementById('search-bar').addEventListener('input', function() {
        const query = this.value.toLowerCase();
        document.querySelectorAll('#forecasts-table-body tr').forEach(row => {
            // Zone is the 3rd column (index 2)
            const zoneCell = row.children[2];
            row.style.display = zoneCell && zoneCell.textContent.toLowerCase().includes(query) ? '' : 'none';
        });
    });
    // Profile Modal Logic
    const profileIconBtn = document.getElementById('profileIconBtn');
    const profileModal = document.getElementById('profileModal');
    const profileModalBackdrop = document.getElementById('profileModalBackdrop');
    const closeProfileModal = document.getElementById('closeProfileModal');
    const profileEditModal = document.getElementById('profileEditModal');
    const profileEditModalBackdrop = document.getElementById('profileEditModalBackdrop');
    const editProfileBtn = document.getElementById('editProfileBtn');
    const closeEditModal = document.getElementById('closeEditModal');
    const profileEditForm = document.getElementById('profileEditForm');
    profileIconBtn.onclick = () => {
      profileModal.style.display = 'flex';
      profileModalBackdrop.style.display = 'block';
      const user = JSON.parse(localStorage.getItem('user') || '{}');
      document.getElementById('profileUsername').textContent = user.name ? `Username: ${user.name}` : '';
      let assignment = '';
      if (user.circuit_id) assignment += `Circuit ID: ${user.circuit_id}  `;
      if (user.zone_id) assignment += `Zone ID: ${user.zone_id}  `;
      if (user.region_id) assignment += `Region ID: ${user.region_id}`;
      document.getElementById('profileAssignment').textContent = assignment || '';
    };
    profileModalBackdrop.onclick = closeProfileModal.onclick = () => {
      profileModal.style.display = 'none';
      profileModalBackdrop.style.display = 'none';
    };
    document.getElementById('logoutBtn').onclick = function() {
      localStorage.removeItem('user');
      window.location.href = '../login.html';
    };
    editProfileBtn.onclick = function() {
      const user = JSON.parse(localStorage.getItem('user') || '{}');
      document.getElementById('editDob').value = user.dob || '';
      document.getElementById('editPhone').value = user.phone_number || '';
      document.getElementById('editSex').value = user.sex || '';
      document.getElementById('editAims').value = user.aims_number || '';
      profileEditModal.style.display = 'flex';
      profileEditModalBackdrop.style.display = 'block';
    };
    closeEditModal.onclick = profileEditModalBackdrop.onclick = function() {
      profileEditModal.style.display = 'none';
      profileEditModalBackdrop.style.display = 'none';
    };
    profileEditForm.onsubmit = async function(e) {
      e.preventDefault();
      const user = JSON.parse(localStorage.getItem('user') || '{}');
      const dob = document.getElementById('editDob').value;
      const phone_number = document.getElementById('editPhone').value;
      const sex = document.getElementById('editSex').value;
      const aims_number = document.getElementById('editAims').value;
      const res = await fetch(`http://localhost:3000/api/users/${user.id}`, {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ dob, phone_number, sex, aims_number })
      });
      if (res.ok) {
        const updated = await res.json();
        Object.assign(user, { dob, phone_number, sex, aims_number });
        localStorage.setItem('user', JSON.stringify(user));
        alert('Profile updated!');
        profileEditModal.style.display = 'none';
        profileEditModalBackdrop.style.display = 'none';
      } else {
        alert('Failed to update profile.');
      }
    };
    document.getElementById('changePassBtn').onclick = function() {
      document.getElementById('profileModal').style.display = 'none';
      document.getElementById('profilePassModal').style.display = 'flex';
      document.getElementById('profilePassModalBackdrop').style.display = 'block';
    };
    </script>
</body>
</html> 